name: CI - Tests
on: 
  push:
    branches-ignore:
        - 'master'
        - 'releases/**'
  workflow_call:      
jobs:
  Tests:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - uses: maxim-lobanov/setup-xcode@v1
      with:
         xcode-version: latest-stable
    - name: create Podfile
      run: bash .github/bash_scripts/podfile_creation.sh
    - name: CocoaPod Install
      run:  pod install
    - name: Detect Available iOS Simulator
      id: detect-simulator
      run: |
        # Try to find specific iPhone simulators first
        SIMULATOR_OUTPUT=$(xcrun simctl list devices available | grep -B 1 "iPhone" | head -2)
        
        if [ -n "$SIMULATOR_OUTPUT" ]; then
          # Specific iPhone simulator found - extract details
          IOS_VERSION=$(echo "$SIMULATOR_OUTPUT" | grep -oE "iOS [0-9]+\.[0-9]+" | sed 's/iOS //')
          SIMULATOR_NAME=$(echo "$SIMULATOR_OUTPUT" | grep "iPhone" | grep -oE "iPhone [^(]+" | sed 's/[[:space:]]*$//')
          
          echo "Found specific simulator: $SIMULATOR_NAME with iOS $IOS_VERSION"
          echo "destination=platform=iOS Simulator,name=$SIMULATOR_NAME,OS=$IOS_VERSION" >> $GITHUB_OUTPUT
        else
          # No specific simulators found - use generic placeholder
          echo "No specific iPhone simulators found, using generic 'Any iOS Simulator Device'"
          echo "destination=platform=iOS Simulator,name=Any iOS Simulator Device" >> $GITHUB_OUTPUT
        fi
    - name: Test
      run: xcodebuild test -scheme segment-appsflyer-ios -workspace segment-appsflyer-ios.xcworkspace -destination '${{ steps.detect-simulator.outputs.destination }}' | xcpretty && exit ${PIPESTATUS[0]}
